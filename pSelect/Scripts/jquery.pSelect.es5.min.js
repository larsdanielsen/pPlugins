"use strict";!function(n){var t=function(t,i,r){r&&(r.stopPropagation(),r.preventDefault());this.$selectBox=n(t);this.options=n.extend({},n.fn.pSelect.defaults,this.$selectBox.data(),typeof i=="object"&&i);this.init()};t.prototype={init:function(){var t=this;this.options.initDone=!1;this.$selectBox.is("[multiple]")&&(this.multiple=!0);this.$wrapperLabel=n("<label />").addClass(this.options.labelClass).addClass(function(){return t.$selectBox.attr("class")});this.options.autoComplete&&this.$wrapperLabel.addClass(this.options.autoCompleteClass);this.$label=n("<span/>").addClass("label-inner");this.$input=n("<input/>").addClass(this.options.inputClass);this.options.autoComplete||this.$input.prop("readonly",!0);this.$selectBox.bind("removeSelect.pSelect",function(){var t=n(this).data("pSelect");t.$wrapperLabel.before(n(this)).remove();n(this).unbind(".pSelect").removeData("pSelect")});this.$selectBox.data("pSelect",this);this.$wrapperLabel.insertBefore(this.$selectBox);this.$wrapperLabel.append(this.$label);this.$wrapperLabel.append(this.$input);this.$wrapperLabel.append(this.$selectBox);this.getUl();this.fillUl();this.bindEvents();this.focusedItemIndex=0;this.ulScrollTop=null;this.moveFocusToNextValidItem();this.updateLabelView();this.options.initDone=!0},open:function(){var t=this;this.options.getUlMaxHeight&&(this.options.ulMaxHeight=this.options.getUlMaxHeight(this));this.$input.val("");this.isOpen=!0;this.fillUl();this.$ul.hide();n("body").append(this.$ul);this.positionUl();this.updateLabelView();n(window).one("click.pSelect touchstart.pSelect resize.pSelect scroll.pSelect",function(){t.close();t.blur()})},blur:function(){this.hasFocus=!1;this.updateLabelView()},focus:function(){this.$input.focus()},close:function(n){this.isOpen&&(this.isOpen=!1,this.updateLabelView(),this.ulScrollTop===null&&(this.ulScrollTop=this.$ul.get(0).scrollTop),this.$ul.detach(),n&&this.focus())},toggle:function(){this.isOpen?this.close():this.open()},updateLabelView:function(t){var i=this;this.updateLabelViewTimeout&&window.clearTimeout(this.updateLabelViewTimeout);this.updateLabelViewTimeout=window.setTimeout(function(){var e,r,u,f,o,s;i.updateLabelViewTimeout=null;i.$wrapperLabel.toggleClass(i.options.openClass,i.isOpen);i.$wrapperLabel.toggleClass(i.options.focusClass,i.hasFocus);e=i.$selectBox.find("option");r="";t===undefined?(i.multiple?(u=e.filter(":selected"),i.options.summeyIfMoreThan>0&&u.length>i.options.summeyIfMoreThan?r=i.options.summeyText.replace("#",u.length).replace("%",i.Struct.items.length):(f=[],u.each(function(){f.push(n(this).text())}),f.length&&(r=f.join(", ")))):(o=i.$selectBox.get(0).selectedIndex,s=n(i.$selectBox.find("option").get(o)),r=s.text()),r==""&&i.options.labelIfNoneSelected&&(r=i.options.labelIfNoneSelected)):r=t;i.$label.text(r)},0)},updateUlView:function(){var n=this;this.updateUlViewTimeout&&window.clearTimeout(this.updateUlViewTimeout);this.updateUlViewTimeout=window.setTimeout(function(){var r,i,t;for(n.updateUlViewTimeout=null,r=!1,i=0;i<n.Struct.items.length;i++)t=n.Struct.items[i],t.$li.toggleClass(n.options.selectedItemClass,t.Selected),t.$li.toggleClass(n.options.disabledItemClass,t.Disabled),t.$li.prop("disabled",t.Disabled),r||t.Index!=this.focusedItemIndex||(r=!0,t.$li.addClass(n.options.focusedItemClass)),t.$li.toggle(!t.Hidden)},0)},bindEvents:function(){var t=this;this.$ul.on("click.pSelect","li",function(i){i.stopPropagation();i.preventDefault();t.selectOption(n(this).data("item"));t.multiple?t.focus():t.close(!0)});this.$ul.on("touchstart.pSelect",function(n){n.stopPropagation()});this.$wrapperLabel.on("click.pSelect",function(n){t.closeOtherInstances();n.stopPropagation()});this.$input.on("focus.pSelect",function(){t.closeOtherInstances();t.hasFocus=!0;t.updateLabelView()});this.$input.on("blur.pSelect",function(){t.isOpen?t.focus():t.blur()});this.$input.on("click.pSelect",function(n){n.stopPropagation();n.preventDefault();t.toggle()});this.$input.on("keydown.pSelect",function(n){t.inputKeyDown(n)});this.$input.on("keypress.pSelect",function(n){t.inputKeyPress(n)});this.$input.on("keyup.pSelect",function(n){t.inputKeyUp(n)});this.$selectBox.on("updateLabelView.pSelect",function(){t.updateLabelView()});this.$selectBox.on("change.pSelect",function(n){n.preventDefault();t.isOpen||t.fillUl();t.updateLabelView()})},getUl:function(){this.$ul=n("<ul/>").addClass(this.options.ulClass);this.options.addSelectClassToLabel&&this.$ul.addClass(this.$selectBox.attr("class"));this.multiple?this.$ul.addClass(this.options.multipleUlClass):this.$ul.addClass(this.options.normalUlClass)},fillUl:function(){var i,t,r;for(this.$ul.empty(),this.getStruct(),i=0;i<this.Struct.items.length;i++)t=this.Struct.items[i],r=n("<li/>").addClass(t.$option.data("classnames")).text(t.Text).data("item",t),t.$li=r,t.$option.is("optgroup")&&t.$li.addClass(this.options.optgroupClass),this.$ul.append(r);this.updateUlView()},getStruct:function(){function f(i){var r=new n.fn.pSelect.Item;r.Text=i.attr("label");r.Selected=!1;r.Disabled=!0;r.Optgroup=!0;r.Index=-1;r.$option=i;t.push(r);i.data("item",r);i.find("> option").each(function(){u(n(this))})}function u(u){if(!i.options.filter||u.text().match(i.options.filter)){var f=new n.fn.pSelect.Item;f.Text=u.text();f.Selected=!!u.is(":selected");f.Disabled=!!u.is(":disabled");f.Index=r;f.$option=u;t.push(f);r++;u.data("item",f)}}var i=this,t=[],r=0;this.$selectBox.children().each(function(){var t=n(this);t.is("option")?u(t):t.is("optgroup")&&f(t)});this.Struct={items:t}},positionUl:function(t){var i=this;this.positionUlTimeout&&window.clearTimeout(this.positionUlTimeout);this.positionUlTimeout=window.setTimeout(function(){var f,s;i.positionUlTimeout=null;var u=i.$wrapperLabel.offset(),e=i.$wrapperLabel.outerHeight(),o=n(window).scrollTop(),r={};if(i.$ul.hide(),r.width=i.$wrapperLabel.outerWidth(),r.left=u.left,i.$ul.css("max-height","0"),t)f=u.top-o,r.maxHeight=f*.8,r.maxHeight>e?(i.$ul.css("max-height",r.maxHeight),r.top=u.top-i.$ul.outerHeight()):(r.top=o,r.maxHeight=e);else if(r.top=u.top+e,f=n(window).outerHeight()-r.top+o,r.maxHeight=f*.8,r.maxHeight<e*4&&f<u.top-o){i.positionUl(!0);return}i.$ul.css(r);i.$ul.show();i.ulScrollTop===null?(s=i.$ul.find("li."+i.options.selectedItemClass).position(),s&&(i.$ul.get(0).scrollTop=s.top)):(i.$ul.get(0).scrollTop=i.ulScrollTop,i.ulScrollTop=null)},0)},selectOption:function(n){n.Selected=this.multiple?!n.Selected:!0;n.$option.prop("selected",n.Selected);this.options.runningInternalChange||(this.options.runningOriginalChange=!0,this.$selectBox.trigger("change"),this.options.runningOriginalChange=!1);this.options.selectCallback&&this.options.selectCallback(this,n);this.updateLabelView();this.updateUlView()},moveFocus:function(n){this.focusedItemIndex+=n;this.moveFocusToNextValidItem(n);this.focusedItemIndex==0&&(n=1);this.focusedItemIndex==this.Struct.items.length-1&&(n=-1);(this.focusedItemIndex==0||this.focusedItemIndex==this.Struct.items.length-1)&&this.moveFocusToNextValidItem(n);this.setFocusToFocusedItem()},moveFocusToNextValidItem:function(n){function i(){return t.focusedItemIndex>=0&&t.focusedItemIndex<t.Struct.items.length}function r(n){return n.Hidden||n.Disabled}n=n||1;for(var t=this;i()&&r(this.Struct.items[this.focusedItemIndex]);)this.focusedItemIndex+=n;this.focusedItemIndex>=this.Struct.items.length&&(this.focusedItemIndex=this.Struct.items.length-1);this.focusedItemIndex<0&&(this.focusedItemIndex=0)},moveFocusUp:function(){this.moveFocus(-1)},moveFocusDown:function(){this.moveFocus(1)},setFocusToFocusedItem:function(){var n=this;window.setTimeout(function(){var t=n.Struct.items[n.focusedItemIndex];n.$ul.children("li").removeClass(n.options.focusedItemClass);t.$li.addClass(n.options.focusedItemClass);n.multiple||n.isOpen||t.$li.trigger("click.pSelect");var i=t.$li.position().top,r=n.$ul.innerHeight(),u=t.$li.outerHeight(!0),f=n.$ul.get(0).scrollTop;i<f?n.$ul.get(0).scrollTop=i:i+u>r+f&&(n.$ul.get(0).scrollTop=u+i-r)},0)},inputKeyDown:function(t){var i=n.fn.pSelect.keyCodes,r=t.keyCode;return r==i.Down?t.altKey?this.open():this.moveFocusDown():r==i.Up?this.moveFocusUp():r==i.Enter||r==i.Space?(t.preventDefault(),(r==i.Enter||this.multiple)&&this.$ul.find("li."+this.options.focusedItemClass).trigger("click.pSelect")):r==i.Esc?this.close():r==i.Tab&&this.close(),r!=i.Tab&&r!=i.Shift,!0},inputKeyPress:function(n){var t=n.charCode||n.keyCode;return this.options.autoComplete||this.findAndSelectNearest(t),!1},inputKeyUp:function(n){if(this.options.autoComplete){var t=n.charCode||n.keyCode,i=n.charCode||n.keyCode;this.filterOptions(i,t)}},findAndSelectNearest:function(n){var i=this,o,r,e,t,c,s,h;if(n!=40&&n!=41){this.options.charsEntered||(this.options.charsEntered=[]);o=String.fromCharCode(n);o!=this.options.charsEntered[0]&&(this.options.charsEntered.push(o),window.clearTimeout(this.options.nearestMatchTimeout),this.options.nearestMatchTimeout=window.setTimeout(function(){i.options.charsEntered=[];i.$input.val("")},1e3));r=this.options.charsEntered.join("");i.$input.val(r);var l=r.length,a=new RegExp(r,"i"),u=[],f=0;for(e=0;e<this.Struct.items.length;e++)(t=this.Struct.items[e],t.Disabled)||(c=t.$li,s=t.Text.substring(0,l),s&&s.match(a)&&(u.push(t),(t.Selected||c.is("."+i.options.focusedItemClass))&&(f=u.length)));f>=u.length&&(f=0);h=u[f];h&&(this.focusedItemIndex=h.Index,this.setFocusToFocusedItem())}},filterOptions:function(t){var i=n.fn.pSelect.keyCodes,f,r,u;if(t!=i.Enter&&t!=i.Up&&t!=i.Down&&t!=i.Esc&&t!=i.Tab){for(f=new RegExp(this.$input.val(),"i"),r=0;r<this.Struct.items.length;r++)(u=this.Struct.items[r],u.Optgroup)||(u.Hidden=!f.test(u.Text));this.updateUlView();this.positionUl();this.focusedItemIndex=0;this.moveFocusUp()}},closeOtherInstances:function(){for(var i,t=0;t<n.fn.pSelect.instances.length;t++)i=n.fn.pSelect.instances[t],i!==this&&(i.close(),i.blur())},options:{},hasFocus:!1,isOpen:!1,updateLabelViewTimeout:null,updateUlViewTimeout:null,positionUlTimeout:null,focusedItemIndex:0,ulScrollTop:null,multiple:!1};n.fn.pSelect=function(i,r){return this.each(function(){var u=n(this),e=typeof i=="object"&&i,f;if(i==="remove"){u.trigger("removeSelect.pSelect");return}u.data("pSelect")&&u.trigger("removeSelect.pSelect");f=new t(this,e,r);n.fn.pSelect.instances.push(f);u.data("pSelect",f)}),this};n.fn.pSelect.defaults={debug:!0,inputClass:"pInput",labelClass:"pSelect",focusClass:"pFocus",openClass:"pOpen",focusedItemClass:"pFocusedItem",selectedItemClass:"pSelectedItem",disabledItemClass:"pDisabledItem",autoCompleteClass:"pAutoComplete",optgroupClass:"pOptgroup",ulClass:"pSelcetUl",normalUlClass:"pNormal",multipleUlClass:"pMultiple",selectCallback:null,addSelectClassToLabel:!1,multiple:!1,autoComplete:!1,labelIfNoneSelected:null,summeyIfMoreThan:0,summeyText:null,ulMaxHeight:null,getUlMaxHeight:null};n.fn.pSelect.instances=[];n.fn.pSelect.keyCodes={Down:40,Up:38,Enter:13,Space:32,Esc:27,Tab:9,Shift:16};n.fn.pSelect.Item=function(){};n.fn.pSelect.Item.prototype={Text:"",Selected:!1,Focused:!1,Disabled:!1,Hidden:!1,Optgroup:!1,Index:0,$option:null,$li:null}}(jQuery);